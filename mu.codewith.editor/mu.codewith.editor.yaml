app-id: mu.codewith.editor
runtime: org.kde.Platform
runtime-version: '5.14'
sdk: org.kde.Sdk
command: mu-editor
build-options:
  no-debuginfo: true
  strip: false
finish-args:
  - --device=all
  - --device=dri
  - --filesystem=home
  - --share=ipc
  - --socket=x11
  - --socket=wayland
modules:
  - name: mu
    ensure-writable:
      - /lib/python3.7/site-packages/easy-install.pth
    build-options:
      env:
        - PYTHONPATH=/app/lib/python3.7/site-packages
    buildsystem: simple
    build-commands:
      - sed -i "s/PyQtChart==/PyQtChart>=/g" setup.py
      - sed -i "s/qscintilla==/qscintilla>=/g" setup.py
      - sed -i "s/QScintilla==/QScintilla>=/g" setup.py
      #- sed -i "s/pyqt5==/pyqt5>=/g" setup.py
      - sed -i "s/'pyqt5==[0-9.]*',//g" setup.py
      - sed -i "/'PyQt5==.*',/d" setup.py
      - python3 setup.py build
      - python3 setup.py install --prefix=/app
      - install -Dm644 conf/mu.codewith.editor.desktop /app/share/applications/mu.codewith.editor.desktop
      - install -Dm644 conf/mu.codewith.editor.png /app/share/icons/hicolor/256x256/apps/mu.codewith.editor.png
      - install -Dm644 conf/mu.appdata.xml /app/share/appdata/mu.codewith.editor.appdata.xml
      - install -Dm644 conf/90-usb-microbit.rules /app/docs/udev_rules/90-usb-microbit.rules
    sources:
#     - type: archive
#       url: https://github.com/mu-editor/mu/archive/1.0.3.tar.gz
#       sha256: d9917794de845231ffea671ceff24824bbe342c9d0da4340b237f7a915c0c358
      - type: git
        url: https://github.com/mu-editor/mu.git
        commit: 235f79c70708b0698dcff7aee2688f29ac375cfb
    modules:
      - name: python-pyqt5-sip
        buildsystem: simple
        build-commands:
          - python3 setup.py build
          - python3 setup.py install --skip-build --prefix=/app
        sources:
          - type: archive
#           url: https://pypi.python.org/packages/source/P/PyQt5-sip/PyQt5_sip-12.7.2.tar.gz
#           sha256: 16a19b9f36985b8bff30b89fb8859d831713dd528fba5600563e36ff077960a2
            url: https://pypi.python.org/packages/source/P/PyQt5-sip/PyQt5_sip-12.8.0.tar.gz
            sha256: 0a34b6596bdd28d52da3a51fa8d9bb0b287bcb605c2512aa3251b9028cc71f4d
      - name: pyqt5
        config-opts:
          - --assume-shared
          - --concatenate
          - --confirm-license
          - --no-designer-plugin
          - --no-dist-info
          - --no-docstrings
          - --no-qml-plugin
          - --no-stubs
          - --no-tools
          - --disable=QtQuick
          - QMAKE_CFLAGS_RELEASE='-I/usr/include/python3.7m'
          - QMAKE_CXXFLAGS_RELEASE='-I/usr/include/python3.7m'
          - --qsci-api
          - --qsci-api-destdir=/app/share/qt/qsci
        sources:
          - type: archive
#           url: https://pypi.python.org/packages/source/P/PyQt5/PyQt5-5.14.0.tar.gz
#           sha256: 0145a6b7de15756366decb736c349a0cb510d706c83fda5b8cd9e0557bc1da72
#           url: https://pypi.python.org/packages/source/P/PyQt5/PyQt5-5.14.2.tar.gz
#           sha256: bd230c6fd699eabf1ceb51e13a8b79b74c00a80272c622427b80141a22269eb0
            url: https://pypi.python.org/packages/source/P/PyQt5/PyQt5-5.15.0.tar.gz
            sha256: c6f75488ffd5365a65893bc64ea82a6957db126fbfe33654bcd43ae1c30c52f9
          - type: script
            commands:
            - processed=`sed -e 's|prefix|sysroot|' <<< $@`
            - python3 configure.py $processed
            dest-filename: configure
        cleanup:
          - /lib/debug
          - /share/sip
        modules:
          - name: sip5
            buildsystem: simple
            ensure-writable:
              - /lib/python3.7/site-packages/easy-install.pth
            build-commands:
              - python3 setup.py build
              - python3 setup.py install --skip-build --prefix=/app
            sources:
              - type: archive
                url: https://pypi.python.org/packages/source/s/sip/sip-5.3.0.tar.gz
                sha256: 03a44e20b252ef03ca2891e9439d238af3fd8245f65cdcff238a843d4f455b80
#           cleanup:
#             - /bin
#             - /include
            modules:
              - name: python-toml
                buildsystem: simple
                ensure-writable:
                  - /lib/python3.7/site-packages/easy-install.pth
                build-commands:
                  - python3 setup.py build
                  - python3 setup.py install --skip-build --prefix=/app
                sources:
                  - type: archive
                    url: https://files.pythonhosted.org/packages/source/t/toml/toml-0.10.1.tar.gz
                    sha256: 926b612be1e5ce0634a2ca03470f95169cf16f939018233a670519cb4ac58b0f
              - name: python-packaging
                buildsystem: simple
                ensure-writable:
                  - /lib/python3.7/site-packages/easy-install.pth
                build-commands:
                  - python3 setup.py build
                  - python3 setup.py install --skip-build --prefix=/app
                sources:
                  - type: archive
                    url: https://pypi.io/packages/source/p/packaging/packaging-20.4.tar.gz
                    sha256: 4357f74f47b9c12db93624a82154e9b120fa8293699949152b22065d556079f8
                modules:
                  - name: python-pyparsing
                    buildsystem: simple
                    ensure-writable:
                      - /lib/python3.7/site-packages/easy-install.pth
                    build-commands:
                      - python3 setup.py build
                      - python3 setup.py install --skip-build --prefix=/app
                    sources:
                      - type: archive
                        url: https://github.com/pyparsing/pyparsing/archive/pyparsing_2.4.7.tar.gz
                        sha256: 6deecf4b95a49a5a9c89b4a4b1fcb73c1cba0e3265ec7b858adffcced229ba05
          - name: pyqt-builder
            buildsystem: simple
            ensure-writable:
              - /lib/python3.7/site-packages/easy-install.pth
            build-commands:
              - python3 setup.py build
              - python3 setup.py install --skip-build --prefix=/app
            sources:
              - type: archive
                url: https://pypi.io/packages/source/P/PyQt-builder/PyQt-builder-1.4.0.tar.gz
                sha256: be7fb8436e6ffb21b7e42266f0fa4776b7d62b0c7e06c63f8a066ff90554fcdc
      - name: python-pyqtchart
        buildsystem: simple
        build-commands:
          - python3 configure.py
            --pyqt-sipdir=/app/share/sip/PyQt5
            --destdir=/app/lib/python3.7/site-packages/PyQt5
            --qtchart-sipdir=/app/share/sip/PyQt5
            --apidir=/app/share/qt/qsci
          - sed -i "s#usr/lib#app/lib#g" Makefile QtChart/Makefile PyQtChart.pro QtChart/QtChart.pro installed.txt
          - make
          - make install
        sources:
          - type: archive
#           url: https://pypi.python.org/packages/source/P/PyQtChart/PyQtChart-5.14.0.tar.gz
#           sha256: f9004861441becab7a4a48e834da14c3976e4c03e5513c93e005d5df36085046
            url: https://pypi.python.org/packages/source/P/PyQtChart/PyQtChart-5.15.0.tar.gz
            sha256: 796b1a966759c78859d019bbac6b88b8e1c72ffebf65acf2be3cd9f45c756661
      - name: qscintilla-qt5
        buildsystem: simple
        build-commands:
          - |
              cd Qt4Qt5
              qmake
              make
              #sed -i "s#usr/lib#app/lib#g" Makefile qscintilla.pro
              #sed -i "s/^all: Makefile/all:/" Makefile
              #sed -i "/Makefile qscintilla.pro/d" Makefile
              #make install
              make DESTDIR=/app INSTALL_ROOT=/app install
              mkdir -p /app/include/Qsci
              mkdir -p \
                /app/include/Qsci \
                /app/share/qt/qsci/api/python \
                /app/share/qt/translations
              mv /app/usr/include/Qsci/* /app/include/Qsci/
              mv /app/usr/lib/x86_64-linux-gnu/* /app/lib/
              mv /app/usr/lib/mkspecs /app/lib/
              mv /app/usr/qsci/api/python/* /app/share/qt/qsci/api/python/
              mv /app/usr/translations/* /app/share/qt/translations/
              rm -rf /app/usr
          - |
              cd designer-Qt4Qt5
              qmake INCLUDEPATH+=../Qt4Qt5 QMAKE_LIBDIR+=../Qt4Qt5
              make
              make DESTDIR=/app INSTALL_ROOT=/app install
              mkdir -p /app/lib/plugins/designer
              mv /app/usr/lib/plugins/designer/libqscintillaplugin.so /app/lib/plugins/designer/
              rm -rf /app/usr
          - python3 Python/configure.py
            --pyqt-sipdir=/app/share/sip/PyQt5
            --destdir=/app/lib/python3.7/site-packages/PyQt5
            --apidir=/app/share/qt/qsci
            --pyqt=PyQt5
            --qsci-incdir=Qt4Qt5
            --qsci-libdir=Qt4Qt5
            --qsci-libdir=Qt4Qt5
            QMAKE_INCDIR+=/usr/include/QtWidgets
            QMAKE_INCDIR+=/usr/include/QtPrintSupport
          - sed -i "s#usr/lib#app/lib#g" Makefile QScintilla.pro installed.txt
          - make
          - make install
        sources:
          - type: archive
            url: https://www.riverbankcomputing.com/static/Downloads/QScintilla/2.11.5/QScintilla-2.11.5.tar.gz
            sha256: 9361e26fd7fb7b5819a7eb92c5c1880a18de9bd3ed9dd2eb008e57388696716b
#     - pypi-dependencies.json
      - name: python-depends
        buildsystem: simple
        build-commands:
          - pip3 install -r mu_requirements.txt --prefix=/app
        build-options:
          build-args:
            - --share=network
        sources:
          - type: file
            path: requirements.txt
            dest-filename: mu_requirements.txt
